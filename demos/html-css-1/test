let
    Source = Sql.Database("PWSQL03.int.capella.lan", "PAR_Ancillary", [Query="WITH #(lf)#(lf)cog1 AS (#(lf)SELECT #(lf)co1.[Action_Name]#(lf)      ,co1.[Action_EmplID]#(lf)      ,co1.[Action_Date]#(lf)      ,co1.[Action_Time]#(lf)      ,co1.[Object_Modified]#(lf)      ,co1.[Original_Value]#(lf)      ,co1.[New_Value]#(lf)      ,co1.[EmplID_Old_Value]#(lf)      ,co1.[EmplID_New_value]#(lf)      ,co1.[Case_Number]#(lf)      ,co1.[Category]#(lf)      ,co1.[Type]#(lf)      ,co1.[Detail]#(lf)      ,co1.[Action_Employee_Index]#(lf)      ,co1.[Original_Employee_Index]#(lf)      ,co1.[New_Employee_Index]#(lf)      ,co1.[Date Time] DateTime#(lf)      ,co1.[First Occurrence Check]#(lf)      ,co1.[Order Index]#(lf)#(lf),CASE WHEN New_Value like '%MOW' THEN 1 ELSE 0 END as New_MOW_Item#(lf),CASE WHEN ad.businessunit = 'ARO' THEN 0 WHEN Object_Modified IN ('Owner','ownerAssignment') AND New_value Not Like '%MOW' THEN 1 #(lf)WHEN Object_Modified = 'Status' AND New_Value IN ('Faculty Review','Closed - Resolved','Auto Closed','Closed - Duplicate', 'Closed-No Action', 'School Review') THEN 1#(lf)ELSE 0 END as Completed_MOW_Item#(lf),ad.BusinessUnit#(lf)#(lf),CASE WHEN New_value = 'Started' And Object_Modified = 'Status' THEN 'Start_Time'#(lf)         WHEN Original_Value = 'Started' And Object_Modified = 'Status' THEN 'End_Time'#(lf)         END as Timer_Thing#(lf)#(lf)  FROM [PAR_Ancillary].[dbo].[CASE_OWNER_HISTORY_TBL] co1#(lf)  left outer join [dbo].[PAR_AGENT_DIMENSIONS_VIEW] ad#(lf)  on ad.autonumber = New_employee_index#(lf)#(lf)INNER JOIN (#(lf)  SELECT DISTINCT#(lf)     case_id#(lf)FROM   #(lf) [dbo].[CASE_OWNER_HISTORY_TBL]  co#(lf)WHERE #(lf) Action_Date >= '2022-06-22'#(lf)AND#(lf)              (#(lf)                     (co.Category = 'Program Planning' AND co.TYPE = 'Change Of')#(lf)              OR (co.Category = 'External Transcripts' AND co.TYPE = 'Transcript Request')#(lf)              OR (co.Category = 'External Transcripts' AND co.TYPE = 'External Transcripts Audit')#(lf)              OR (co.category = 'Academic Change Team') OR (co.category = 'Admissions') OR (co.Category = 'Transfer Credit Evaluation') OR (co.Category = 'Degree Review') #(lf)              OR (co.Category = 'Records and Registration') OR (co.Category = 'Doc Management')#(lf)              )#(lf)                     ) sq1#(lf)ON co1.Case_id = sq1.Case_id#(lf)#(lf))#(lf)#(lf), CTE2 AS (#(lf)#(lf)SELECT#(lf)cog1.[Action_Name]#(lf)      ,cog1.[Action_EmplID]#(lf)      ,cog1.[Action_Date]#(lf)      ,cog1.[Action_Time]#(lf)      ,cog1.[Object_Modified]#(lf)      ,cog1.[Original_Value]#(lf)      ,cog1.[New_Value]#(lf)      ,cog1.[EmplID_Old_Value]#(lf)      ,cog1.[EmplID_New_value]#(lf)      ,cog1.[Case_Number]#(lf)      ,cog1.[Category]#(lf)      ,cog1.[Type]#(lf)      ,cog1.[Detail]#(lf)      ,cog1.[Action_Employee_Index]#(lf)      ,cog1.[Original_Employee_Index]#(lf)      ,cog1.[New_Employee_Index]#(lf)      ,cog1.[DateTime] #(lf)      ,cog1.[First Occurrence Check]#(lf)      ,cog1.[Order Index]#(lf),cog1.New_MOW_Item#(lf),cog1.Completed_MOW_Item#(lf),MAX(cog2.[Order Index]) MostRecentEntrancetoInventory#(lf),MAX(cog2.DateTime) CreatedDateTime#(lf),MAX(cog3.[Order Index]) MostRecentCompletion #(lf),MAX(cog3.DateTime) CompletedDateTime#(lf),cog1.BusinessUnit#(lf)#(lf)#(lf),MAX(cog4.[Order Index]) MostRecentStart#(lf),MAX(cog4.DateTime) StartedDateTime#(lf),MAX(cog5.[Order Index]) MostRecentEnd#(lf),MAX(cog5.DateTime) EndDateTime#(lf)#(lf)#(lf)#(lf)#(lf)FROM cog1#(lf)LEFT OUTER JOIN cog1 cog2#(lf)ON cog2.Case_Number = cog1.Case_Number#(lf)AND cog2.[Order Index] <= cog1.[Order Index]#(lf)AND cog2.New_MOW_Item = 1#(lf)#(lf)LEFT OUTER JOIN cog1 cog3#(lf)ON cog3.Case_Number = cog1.Case_Number#(lf)AND cog3.[Order Index] <= cog1.[Order Index]#(lf)AND cog3.Completed_MOW_Item = 1#(lf)#(lf)LEFT OUTER JOIN cog1 cog4#(lf)ON cog4.Case_Number = cog1.Case_Number#(lf)AND cog4.[Order Index] <= cog1.[Order Index]#(lf)AND cog4.Timer_Thing = 'Start_Time'#(lf)#(lf)LEFT OUTER JOIN cog1 cog5#(lf)ON cog5.Case_Number = cog1.Case_Number#(lf)AND cog5.[Order Index] <= cog1.[Order Index]#(lf)AND cog5.Timer_Thing = 'End_Time'#(lf)#(lf)#(lf)GROUP BY#(lf)cog1.[Action_Name]#(lf)      ,cog1.[Action_EmplID]#(lf)      ,cog1.[Action_Date]#(lf)      ,cog1.[Action_Time]#(lf)      ,cog1.[Object_Modified]#(lf)      ,cog1.[Original_Value]#(lf)      ,cog1.[New_Value]#(lf)      ,cog1.[EmplID_Old_Value]#(lf)      ,cog1.[EmplID_New_value]#(lf)      ,cog1.[Case_Number]#(lf)      ,cog1.[Category]#(lf)      ,cog1.[Type]#(lf)      ,cog1.[Detail]#(lf)      ,cog1.[Action_Employee_Index]#(lf)      ,cog1.[Original_Employee_Index]#(lf)      ,cog1.[New_Employee_Index]#(lf)      ,cog1.[DateTime] #(lf)      ,cog1.[First Occurrence Check]#(lf)      ,cog1.[Order Index]#(lf),cog1.New_MOW_Item#(lf),cog1.Completed_MOW_Item#(lf),cog1.BusinessUnit#(lf))#(lf)#(lf)#(lf)SELECT DISTINCT#(lf)CTE2.[Action_Name]#(lf)      ,CTE2.[Action_EmplID]#(lf)      ,CTE2.[Action_Date]#(lf)      ,CTE2.[Action_Time]#(lf)      ,CTE2.[Object_Modified]#(lf)      ,CTE2.[Original_Value]#(lf)      ,CTE2.[New_Value]#(lf)      ,CTE2.[EmplID_Old_Value]#(lf)      ,CTE2.[EmplID_New_value]#(lf)      ,CTE2.[Case_Number]#(lf)      ,CTE2.[Category]#(lf)      ,CTE2.[Type]#(lf)      ,CTE2.[Detail]#(lf)      ,CTE2.[Action_Employee_Index]#(lf)      ,CTE2.[Original_Employee_Index]#(lf)      ,CTE2.[New_Employee_Index]#(lf)      ,CTE2.[DateTime] #(lf)      ,CTE2.[First Occurrence Check]#(lf)      ,CTE2.[Order Index]#(lf)#(lf),CASE WHEN CTE2.MostRecentEntrancetoInventory > ISNULL(CTE2.MostRecentCompletion,0) THEN 'Yes' ELSE 'No' END In_Inventory#(lf),CTE2.BusinessUnit#(lf),CASE #(lf)WHEN CTE2.MostRecentEntrancetoInventory > ISNULL(CTE2.MostRecentCompletion,0) THEN NULL #(lf)WHEN t2.MostRecentEntrancetoInventory <= ISNULL(t2.MostRecentCompletion,0) THEN NULL#(lf)ELSE DateDiff(s,CTE2.CreatedDateTime,CTE2.CompletedDateTime) END/3600.0 Duration_Hrs#(lf)#(lf),CASE #(lf)WHEN CTE2.MostRecentStart > ISNULL(CTE2.MostRecentEnd,0) THEN NULL #(lf)WHEN t2.MostRecentStart <= ISNULL(t2.MostRecentEnd,0) THEN NULL#(lf)WHEN CTE2.Object_Modified <> 'Status' THEN NULL#(lf)ELSE DateDiff(s,CTE2.StartedDateTime,CTE2.EndDateTime) END/60.0 Actual_Handle_Minutes#(lf)#(lf)#(lf)#(lf)FROM CTE2#(lf)LEFT OUTER JOIN CTE2 t2#(lf)ON t2.Case_Number = CTE2.Case_Number#(lf)AND t2.[Order Index] = CTE2.[Order Index]-1#(lf)#(lf)"]),
    #"Removed Columns" = Table.RemoveColumns(Source,{"First Occurrence Check"}),
    #"Renamed Columns" = Table.RenameColumns(#"Removed Columns",{{"DateTime", "Date Time"}})
in
    #"Renamed Columns"